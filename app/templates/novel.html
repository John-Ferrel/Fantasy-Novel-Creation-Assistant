<!DOCTYPE html>
<html>
<head>
    <title>{{ project.title }} - åˆ›ä½œ</title>
    <style>
        body { margin: 0; display: flex; }
        #sidebar {
            width: 250px;
            background: #f8f9fa;
            padding: 20px;
            height: 100vh;
        }
        #content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .block {
            margin: 20px 0;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
        }
        .block-controls {
            margin-top: 10px;
        }
        button {
            padding: 5px 10px;
            margin-right: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>{{ project.title }}</h3>
        <div>
            <button onclick="location.href='/setting/{{ project.id }}'">âš™ï¸ è®¾å®šç®¡ç†</button>
        </div>
        <h4>ç« èŠ‚ç›®å½•</h4>
        <div id="chapters">
            {% for chapter in chapters %}
            <div style="margin: 5px 0;">
                <a href="#" onclick="loadChapter({{ chapter.id }})">{{ chapter.title }}</a>
            </div>
            {% endfor %}
        </div>
        <button onclick="addChapter()">+ æ·»åŠ ç« èŠ‚</button>
        <div style="margin: 15px 0;">
            <button onclick="window.location.href='/'">â† è¿”å›é¡¹ç›®åˆ—è¡¨</button>
        </div>
    </div>

    <div id="content">
        <h2 id="chapter-title"></h2>
        <div id="blocks"></div>
        <button onclick="addBlock()">+ æ·»åŠ æ–‡æœ¬å—</button>
        <button onclick="saveContent()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <script>
        let currentChapterId = null;

        // åŠ è½½ç« èŠ‚å†…å®¹
        async function loadChapter(chapterId) {
            const res = await fetch(`/chapter/${chapterId}`);
            const data = await res.json();
            
            document.getElementById('chapter-title').textContent = data.title;
            const blocksDiv = document.getElementById('blocks');
            blocksDiv.innerHTML = '';
            
            data.content.forEach((text, index) => {
                blocksDiv.innerHTML += `
                    <div class="block" data-index="${index}">
                        <div class="content" contenteditable>${text}</div>
                        <div class="block-controls">
                            <button onclick="generateText(this, 'ç»­å†™')">ç»­å†™</button>
                            <button onclick="generateText(this, 'æ‰©å†™')">æ‰©å†™</button>
                        </div>
                    </div>
                `;
            });
            currentChapterId = chapterId;
        }

        // ä¿å­˜å†…å®¹
        async function saveContent() {
            const contents = Array.from(document.querySelectorAll('.content'))
                            .map(el => el.innerHTML);
            await fetch(`/chapter/${currentChapterId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: contents })
            });
            alert('ä¿å­˜æˆåŠŸï¼');
        }

        // æ–‡æœ¬å—æ“ä½œ
        async function generateText(button, action) {
            const block = button.closest('.block');
            const currentText = block.querySelector('.content').innerHTML;
            
            const res = await fetch('/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: action,
                    current_text: currentText,
                    project_id: {{ project.id }},
                    chapter_id: currentChapterId
                })
            });
            const data = await res.json();
            
            if (action === 'ç»­å†™') {
                block.querySelector('.content').innerHTML += data.generated_text;
            } else {
                block.querySelector('.content').innerHTML = data.generated_text;
            }
        }

        // æ·»åŠ ç« èŠ‚åŠŸèƒ½
        async function addChapter() {
        const title = prompt('è¯·è¾“å…¥æ–°ç« èŠ‚æ ‡é¢˜ï¼š');
        if (title) {
            const res = await fetch('/chapter', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    project_id: {{ project.id }},
                    order: {{ chapters|length + 1 }}
                })
            });
            const data = await res.json();
            location.reload(); // åˆ·æ–°ç« èŠ‚åˆ—è¡¨
        }
    }

    // æ·»åŠ æ–‡æœ¬å—åŠŸèƒ½
    async function addBlock() {
        if (!currentChapterId) {
            alert('è¯·å…ˆé€‰æ‹©ç« èŠ‚');
            return;
        }
        
        // è·å–å½“å‰æ‰€æœ‰å†…å®¹
        const contents = Array.from(document.querySelectorAll('.content'))
                            .map(el => el.innerHTML);
        // æ·»åŠ æ–°å—
        contents.push('æ–°æ–‡æœ¬å—');
        
        // ä¿å­˜æ›´æ–°
        await fetch(`/chapter/${currentChapterId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content: contents })
        });
        
        // é‡æ–°åŠ è½½
        loadChapter(currentChapterId);
    }

    // åˆå§‹åŒ–åŠ è½½ç¬¬ä¸€ä¸ªç« èŠ‚
    {% if chapters %}
    loadChapter({{ chapters[0].id }});
    {% endif %}
    </script>
</body>
</html>